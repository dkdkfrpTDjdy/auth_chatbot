name: Deploy to Elastic Beanstalk

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm install

      - name: Build (Vite)
        run: npm run build

      - name: Make deploy.zip (EB safe paths)
        shell: bash
        run: |
          python - <<'PY'
          import os, zipfile
      
          EXCLUDE_DIRS = {".git", ".github", "node_modules"}
          EXCLUDE_FILES_PREFIX = {".env"}  # .env, .env.local 등 제외
          OUT = "deploy.zip"
      
          def should_skip_file(rel):
              base = os.path.basename(rel)
              if base == OUT:
                  return True
              if base.startswith(".env"):
                  return True
              return False
      
          with zipfile.ZipFile(OUT, "w", compression=zipfile.ZIP_DEFLATED) as z:
              for root, dirs, files in os.walk("."):
                  # 제외 디렉토리 제거
                  dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]
                  for f in files:
                      full = os.path.join(root, f)
                      rel = os.path.relpath(full, ".")
                      if should_skip_file(rel):
                          continue
                      # zip 안 경로는 무조건 "/" 사용 (EB unzip 경고 방지)
                      arc = rel.replace(os.sep, "/")
                      z.write(full, arc)
      
          print("Created", OUT)
          PY
      
      - name: Verify deploy.zip has no backslashes
        shell: bash
        run: |
          python - <<'PY'
          import zipfile, sys
          with zipfile.ZipFile("deploy.zip") as z:
            bad = [n for n in z.namelist() if "\\" in n]
          if bad:
            print("ERROR: backslashes found in zip paths:", bad[:20])
            sys.exit(1)
          print("OK: zip paths look safe")
          PY

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v22
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: "ajnet-support-authbot"
          environment_name: "Ajnet-support-authbot-env"
          region: "ap-southeast-2"
          version_label: "github-${{ github.run_id }}-${{ github.run_attempt }}"
          use_existing_version_if_available: true
          deployment_package: deploy.zip
